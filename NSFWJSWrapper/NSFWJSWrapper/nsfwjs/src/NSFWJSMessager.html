<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://unpkg.com/@tensorflow/tfjs@2.6.0" type="text/javascript"></script>
    <script src="https://unpkg.com/nsfwjs@2.3.0" type="text/javascript"></script>
    <script>

        function debugLog(msg) {
            console.log("=====[debugLog-begin]======");
            console.log(msg);
            console.log("======[debugLog-end]======");
        }

        function nativeOnCall(userInfo) {
            window.webkit.messageHandlers.nativeOnCall.postMessage(userInfo);
        }
        
        function classifyImage(uuid, imageData) {
            // debugLog("classifyImage" + uuid + imageData);
            _callClassify(imageData)
                .then((ret) => {
                    // debugLog("_callClassify2");
                    debugLog(ret);
                    nativeOnCall({uuid: uuid,result: ret});
                })
                .catch((error) => {
                    // debugLog("catch");
                    debugLog(error);
                });
        }

        // 传入base64 编码后的图片文件内容
        function _callClassify(source) {
            // const nsfwjs = require('nsfwjs')
            const img = new Image();
            img.crossOrigin = "anonymous";
            // some image here
            // img.src = "https://i.imgur.com/Kwxetau.jpg";
            img.src = source;
            // Load the model.
            return new Promise(function (resolve, reject) {
                nsfwjs.load()
                    .then((model) => {
                        
                        model
                            .classify(img)
                            .then((predictions) => {
                                var ret = predictions.map(obj => ({
                                    "className": obj["className"],
                                    "probability": obj["probability"],
                                }));
                                console.log("Predictions", predictions);
                                resolve(ret);
                            }).catch((error) => {
                                reject(error);
                            });
                    })
                    .catch((error) => {
                        reject(error);
                    });
            });
        }
    </script>
    <title>NSFWJS</title>
</head>

<body>

</body>

</html>